{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 页面头部 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="mobile-text-center">
                <div class="responsive-title">
                    <h1 class="h3 mb-1">
                        <i class="bi bi-graph-up me-2 text-warning"></i>
                        {{ title }}
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">项目看板</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('main.project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                            <li class="breadcrumb-item active" aria-current="page">收益分析</li>
                        </ol>
                    </nav>
                </div>
                <div class="mobile-full-width mobile-stack gap-2">
                    <a href="{{ url_for('main.project_detail', project_id=project.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1 mobile-hidden"></i><span class="desktop-hidden">返回</span><span class="mobile-hidden">返回项目详情</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row responsive-grid">
        <!-- 项目成本信息卡片 -->
        <div class="col-lg-4 col-md-12 col-12 mb-4">
            <div class="card responsive-card">
                <div class="card-header bg-primary text-white mobile-text-center">
                    <h5 class="mb-0 responsive-text">
                        <i class="bi bi-info-circle me-2"></i>项目成本信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 text-primary fw-bold">{{ profit_analysis_record.total_project_cost }}</div>
                        <small class="text-muted">万元</small>
                    </div>
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="icon-wrapper me-3">
                            <i class="bi bi-calculator text-primary"></i>
                        </div>
                        <div>
                            <small class="text-muted">项目工程总造价</small>
                            <div class="fw-bold">{{ project.name }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 收益分析表单 -->
        <div class="col-lg-8 col-md-12 col-12">
            <div class="card responsive-card">
                <div class="card-header bg-warning text-dark mobile-text-center">
                    <h5 class="mb-0 responsive-text">
                        <i class="bi bi-graph-up me-2"></i>收益分析计算
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>提示：</strong>请填写相关参数进行收益分析计算，系统将自动计算项目的预期收益。
                    </div>
                    
                    <form action="" method="post" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row g-4 responsive-grid">
                            <!-- 委托费收益参数 -->
                            <div class="col-12">
                                <h6 class="text-primary mb-3 mobile-text-center responsive-text">
                                    <i class="bi bi-cash-coin me-2"></i>委托费收益参数
                                </h6>
                            </div>
                            
                            <div class="col-lg-6 col-md-6 col-12">
                                <div class="form-floating">
                                    {{ form.dev_fee_rate(class="form-control", placeholder="请输入开发收益费率") }}
                                    {{ form.dev_fee_rate.label(class="form-label responsive-text") }}
                                    {% for error in form.dev_fee_rate.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ form.dev_fee_rate.description }}</small>
                            </div>
                            
                            <div class="col-lg-6 col-md-6 col-12">
                                <div class="form-floating">
                                    {{ form.extra_investment(class="form-control", placeholder="请输入额外投资金额") }}
                                    {{ form.extra_investment.label(class="form-label responsive-text") }}
                                    {% for error in form.extra_investment.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ form.extra_investment.description }}</small>
                            </div>
                            
                            <!-- 资源费分成参数 -->
                            <div class="col-12 mt-4">
                                <h6 class="text-success mb-3 mobile-text-center responsive-text">
                                    <i class="bi bi-pie-chart me-2"></i>资源费分成参数
                                </h6>
                            </div>
                            
                            <div class="col-lg-6 col-md-6 col-12">
                                <div class="form-floating">
                                    {{ form.resource_fee_total(class="form-control", placeholder="请输入资源费总额") }}
                                    {{ form.resource_fee_total.label(class="form-label responsive-text") }}
                                    {% for error in form.resource_fee_total.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ form.resource_fee_total.description }}</small>
                            </div>
                            
                            <!-- ROI计算参数 -->
                            <div class="col-lg-6 col-md-6 col-12">
                                <div class="form-floating">
                                    {{ form.dengpin_cost(class="form-control", placeholder="请输入登品投入成本") }}
                                    {{ form.dengpin_cost.label(class="form-label responsive-text") }}
                                    {% for error in form.dengpin_cost.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ form.dengpin_cost.description }}</small>
                            </div>
                            
                            <!-- 兼容性字段（已废弃） -->
                            <div class="col-12 mt-4">
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>注意：</strong>以下字段已废弃，仅用于数据迁移兼容性
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.market_profit_rate(class="form-control", placeholder="已废弃字段", disabled=true) }}
                                    {{ form.market_profit_rate.label(class="form-label") }}
                                </div>
                                <small class="text-muted">{{ form.market_profit_rate.description }}</small>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            {{ form.submit(class="btn btn-warning btn-lg px-5 mobile-full-width") }}
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 收益分析说明 -->
            <div class="card mt-4 responsive-card">
                <div class="card-header mobile-text-center">
                    <h6 class="mb-0 responsive-text">
                        <i class="bi bi-question-circle me-1"></i>收益分析说明
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row responsive-grid">
                        <div class="col-lg-6 col-md-6 col-12">
                            <h6 class="text-warning mobile-text-center responsive-text">分析内容</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check-circle text-success me-2"></i>市场利润率分析</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>投资回报计算</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>资源费用评估</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>总收益预测</li>
                            </ul>
                        </div>
                        <div class="col-lg-6 col-md-6 col-12">
                            <h6 class="text-warning mobile-text-center responsive-text">计算公式</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-gear text-info me-2"></i>委托费收益计算</li>
                                <li><i class="bi bi-gear text-info me-2"></i>资源费收益计算</li>
                                <li><i class="bi bi-gear text-info me-2"></i>总收益汇总</li>
                                <li><i class="bi bi-gear text-info me-2"></i>利润率分析</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 收益分析结果显示 -->
    {% if profit_analysis_record.commission_income is not none %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success responsive-card">
                <div class="card-header bg-success text-white mobile-text-center">
                    <h5 class="mb-0 responsive-text">
                        <i class="bi bi-graph-up-arrow me-2"></i>收益分析结果
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 收益指标卡片 -->
                    <div class="row g-4 mb-4 responsive-grid">
                        <!-- 委托费收益 -->
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="card bg-primary text-white h-100 responsive-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-cash-coin display-6 mb-2"></i>
                                    <h6 class="card-title responsive-text">委托费收益</h6>
                                    <div class="display-6 fw-bold">{{ "%.2f"|format(profit_analysis_record.commission_income or 0) }}</div>
                                    <small>万元</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 资源费收益 -->
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="card bg-success text-white h-100 responsive-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-pie-chart display-6 mb-2"></i>
                                    <h6 class="card-title responsive-text">资源费收益</h6>
                                    <div class="display-6 fw-bold">{{ "%.2f"|format(profit_analysis_record.resource_income or 0) }}</div>
                                    <small>万元</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 项目总收益 -->
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="card bg-warning text-dark h-100 responsive-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-trophy display-6 mb-2"></i>
                                    <h6 class="card-title responsive-text">项目总收益</h6>
                                    <div class="display-6 fw-bold">{{ "%.2f"|format(profit_analysis_record.total_income or 0) }}</div>
                                    <small>万元</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 投资回报率 -->
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="card bg-info text-white h-100 responsive-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-percent display-6 mb-2"></i>
                                    <h6 class="card-title responsive-text">投资回报率</h6>
                                    <div class="display-6 fw-bold">{{ "%.2f"|format(profit_analysis_record.roi_percentage or 0) }}</div>
                                    <small>%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 详细分析表格 -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-success mb-3 mobile-text-center responsive-text">
                                <i class="bi bi-table me-2"></i>详细收益分析
                            </h6>
                            <!-- 桌面端表格视图 -->
                            <div class="table-responsive desktop-only">
                                <table class="table table-striped table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>分析项目</th>
                                            <th>计算参数</th>
                                            <th>计算结果</th>
                                            <th>备注</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>委托费收益</strong></td>
                                            <td>
                                                装机容量: {{ project.capacity_mw }} MW<br>
                                                开发费率: {{ "%.3f"|format(profit_analysis_record.dev_fee_rate or 0.1) }} 元/W<br>
                                                额外投资: {{ "%.2f"|format(profit_analysis_record.extra_investment or 0) }} 万元
                                            </td>
                                            <td class="text-primary fw-bold">{{ "%.2f"|format(profit_analysis_record.commission_income or 0) }} 万元</td>
                                            <td>Model 4.1</td>
                                        </tr>
                                        <tr>
                                            <td><strong>资源费分成</strong></td>
                                            <td>
                                                资源费总额: {{ "%.2f"|format(profit_analysis_record.resource_fee_total or 0) }} 万元<br>
                                                分成比例: 累进制
                                            </td>
                                            <td class="text-success fw-bold">{{ "%.2f"|format(profit_analysis_record.resource_income or 0) }} 万元</td>
                                            <td>Model 4.2</td>
                                        </tr>
                                        <tr>
                                            <td><strong>净利润</strong></td>
                                            <td>
                                                总收益: {{ "%.2f"|format(profit_analysis_record.total_income or 0) }} 万元<br>
                                                登品成本: {{ "%.2f"|format(profit_analysis_record.dengpin_cost or 0) }} 万元
                                            </td>
                                            <td class="text-warning fw-bold">{{ "%.2f"|format(profit_analysis_record.net_profit or 0) }} 万元</td>
                                            <td>总收益 - 成本</td>
                                        </tr>
                                        <tr>
                                            <td><strong>投资回报率</strong></td>
                                            <td>
                                                净利润: {{ "%.2f"|format(profit_analysis_record.net_profit or 0) }} 万元<br>
                                                投入成本: {{ "%.2f"|format(profit_analysis_record.dengpin_cost or 0) }} 万元
                                            </td>
                                            <td class="text-info fw-bold">{{ "%.2f"|format(profit_analysis_record.roi_percentage or 0) }}%</td>
                                            <td>Model 5.2</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 移动端卡片视图 -->
                            <div class="mobile-only">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="card responsive-card">
                                            <div class="card-body">
                                                <h6 class="text-primary mb-2 responsive-text">委托费收益</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted">装机容量:</small> {{ project.capacity_mw }} MW<br>
                                                    <small class="text-muted">开发费率:</small> {{ "%.3f"|format(profit_analysis_record.dev_fee_rate or 0.1) }} 元/W<br>
                                                    <small class="text-muted">额外投资:</small> {{ "%.2f"|format(profit_analysis_record.extra_investment or 0) }} 万元
                                                </div>
                                                <div class="text-primary fw-bold">{{ "%.2f"|format(profit_analysis_record.commission_income or 0) }} 万元</div>
                                                <small class="text-muted">Model 4.1</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="card responsive-card">
                                            <div class="card-body">
                                                <h6 class="text-success mb-2 responsive-text">资源费分成</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted">资源费总额:</small> {{ "%.2f"|format(profit_analysis_record.resource_fee_total or 0) }} 万元<br>
                                                    <small class="text-muted">分成比例:</small> 累进制
                                                </div>
                                                <div class="text-success fw-bold">{{ "%.2f"|format(profit_analysis_record.resource_income or 0) }} 万元</div>
                                                <small class="text-muted">Model 4.2</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="card responsive-card">
                                            <div class="card-body">
                                                <h6 class="text-warning mb-2 responsive-text">净利润</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted">总收益:</small> {{ "%.2f"|format(profit_analysis_record.total_income or 0) }} 万元<br>
                                                    <small class="text-muted">登品成本:</small> {{ "%.2f"|format(profit_analysis_record.dengpin_cost or 0) }} 万元
                                                </div>
                                                <div class="text-warning fw-bold">{{ "%.2f"|format(profit_analysis_record.net_profit or 0) }} 万元</div>
                                                <small class="text-muted">总收益 - 成本</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="card responsive-card">
                                            <div class="card-body">
                                                <h6 class="text-info mb-2 responsive-text">投资回报率</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted">净利润:</small> {{ "%.2f"|format(profit_analysis_record.net_profit or 0) }} 万元<br>
                                                    <small class="text-muted">投入成本:</small> {{ "%.2f"|format(profit_analysis_record.dengpin_cost or 0) }} 万元
                                                </div>
                                                <div class="text-info fw-bold">{{ "%.2f"|format(profit_analysis_record.roi_percentage or 0) }}%</div>
                                                <small class="text-muted">Model 5.2</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 计算公式说明 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info responsive-card" role="alert">
                                <h6 class="alert-heading mobile-text-center responsive-text">
                                    <i class="bi bi-info-circle me-2"></i>计算公式说明
                                </h6>
                                <div class="row responsive-grid">
                                    <div class="col-lg-6 col-md-6 col-12">
                                        <p class="mb-2 responsive-text"><strong>委托费收益 (Model 4.1):</strong></p>
                                        <code>收益 = (装机容量MW × 1,000,000W × 开发费率元/W ÷ 10,000) - 额外投资万元</code>
                                        
                                        <p class="mb-2 mt-3 responsive-text"><strong>资源费分成 (Model 4.2):</strong></p>
                                        <code>≤4000万元: 25%分成<br>4000-8000万元: 75%分成<br>>8000万元: 66.67%分成</code>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-12">
                                        <p class="mb-2 responsive-text"><strong>项目总收益 (Model 5.1):</strong></p>
                                        <code>总收益 = 委托费收益 + 资源费分成收益</code>
                                        
                                        <p class="mb-2 mt-3 responsive-text"><strong>投资回报率 (Model 5.2):</strong></p>
                                        <code>ROI% = (净利润 ÷ 登品投入成本) × 100%</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}