{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <div class="col-xl-6 col-lg-8 col-md-10 col-12">
            <div class="card responsive-card">
                <div class="card-header bg-primary text-white mobile-text-center">
                    <h4 class="mb-0 responsive-title">
                        <i class="bi bi-{{ 'plus-circle' if title == '创建项目' else 'pencil-square' }} me-2"></i>
                        {{ title }}
                    </h4>
                </div>
            <div class="card-body p-4">
                <form action="" method="post" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <div class="row responsive-grid">
                        <div class="col-lg-6 col-md-6 col-12">
                            <div class="form-group mb-3">
                                {{ form.name.label(class="form-label responsive-text") }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-building"></i>
                                    </span>
                                    {{ form.name(class="form-control", placeholder="请输入项目名称") }}
                                </div>
                                {% for error in form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-lg-6 col-md-6 col-12">
                            <div class="form-group mb-3">
                                {{ form.project_type.label(class="form-label responsive-text") }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-lightning-charge"></i>
                                    </span>
                                    {{ form.project_type(class="form-select") }}
                                </div>
                                {% for error in form.project_type.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row responsive-grid">
                        <div class="col-lg-6 col-md-6 col-12">
                            <div class="form-group mb-3">
                                {{ form.capacity_mw.label(class="form-label responsive-text") }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-speedometer2"></i>
                                    </span>
                                    {{ form.capacity_mw(class="form-control", placeholder="请输入装机容量") }}
                                    <span class="input-group-text">MW</span>
                                </div>
                                {% for error in form.capacity_mw.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-lg-6 col-md-6 col-12">
                            <div class="form-group mb-3">
                                {{ form.current_stage.label(class="form-label responsive-text") }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-diagram-3"></i>
                                    </span>
                                    {{ form.current_stage(class="form-select") }}
                                </div>
                                {% for error in form.current_stage.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 地理信息字段 -->
                    <div class="card mt-4 mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-geo-alt me-2"></i>项目位置 (可选)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row responsive-grid">
                                <div class="col-12">
                                    <div class="form-group mb-3">
                                        <label class="form-label responsive-text">项目地址</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-geo-alt"></i>
                                            </span>
                                            <input type="text" id="address-input" class="form-control" placeholder="请输入项目地址或点击地图选择位置" autocomplete="off">
                                            <button type="button" class="btn btn-outline-secondary" id="map-select-btn">
                                                <i class="bi bi-map"></i> 地图选择
                                            </button>
                                        </div>
                                        <div id="address-suggestions" class="list-group position-absolute" style="z-index: 1000; width: calc(100% - 120px); margin-left: 42px; display: none;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 隐藏的表单字段用于存储数据 -->
                            {{ form.address(style="display: none;", id="hidden-address") }}
                            {{ form.province(style="display: none;", id="hidden-province") }}
                            {{ form.city(style="display: none;", id="hidden-city") }}
                            {{ form.district(style="display: none;", id="hidden-district") }}
                            {{ form.longitude(style="display: none;", id="hidden-longitude") }}
                            {{ form.latitude(style="display: none;", id="hidden-latitude") }}
                            
                            <!-- 地图选择模态框 -->
                            <div class="modal fade" id="mapSelectModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <i class="bi bi-map me-2"></i>选择项目位置
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-search"></i>
                                                    </span>
                                                    <input type="text" id="map-search-input" class="form-control" placeholder="搜索地址...">
                                                    <button type="button" class="btn btn-outline-secondary" id="get-location-btn">
                                                        <i class="bi bi-geo-alt"></i> 当前位置
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="map-container" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
                                            <div class="mt-3">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <strong>选中地址：</strong>
                                                        <span id="selected-address">请在地图上点击选择位置</span>
                                                    </div>
                                                    <div class="col-md-4 text-end">
                                                        <strong>坐标：</strong>
                                                        <span id="selected-coordinates">-</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                            <button type="button" class="btn btn-primary" id="confirm-location-btn" disabled>确认选择</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>提示：</strong>您可以直接输入地址搜索，或点击"地图选择"按钮在地图上选择项目位置。
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between mobile-stack gap-2">
                        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary mobile-full-width">
                            <i class="bi bi-arrow-left me-1"></i><span class="mobile-hidden">返回</span><span class="desktop-hidden">返回</span>
                        </a>
                        {{ form.submit(class="btn btn-primary px-4 mobile-full-width") }}
                    </div>
                </form>
            </div>
        </div>
        
            <!-- 项目类型说明卡片 -->
            <div class="card mt-4 responsive-card">
                <div class="card-header mobile-text-center">
                    <h6 class="mb-0 responsive-text">
                        <i class="bi bi-info-circle me-1"></i>项目类型说明
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row responsive-grid">
                        <div class="col-lg-4 col-md-4 col-sm-6 col-12 mb-3">
                            <div class="d-flex align-items-center mb-2 mobile-text-center">
                                <i class="bi bi-sun text-warning me-2"></i>
                                <strong class="responsive-text">光伏发电</strong>
                            </div>
                            <small class="text-muted mobile-text-center d-block">利用太阳能发电的清洁能源项目</small>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-6 col-12 mb-3">
                            <div class="d-flex align-items-center mb-2 mobile-text-center">
                                <i class="bi bi-wind text-info me-2"></i>
                                <strong class="responsive-text">风力发电</strong>
                            </div>
                            <small class="text-muted mobile-text-center d-block">利用风能发电的可再生能源项目</small>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-6 col-12 mb-3">
                            <div class="d-flex align-items-center mb-2 mobile-text-center">
                                <i class="bi bi-battery-charging text-success me-2"></i>
                                <strong class="responsive-text">储能系统</strong>
                            </div>
                            <small class="text-muted mobile-text-center d-block">电能存储和调节系统项目</small>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<!-- 高德地图API -->
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=8398f6f401c52243bd6b510e638c2353&plugin=AMap.PlaceSearch,AMap.Autocomplete,AMap.Geocoder"></script>

<script>
$(document).ready(function() {
    let map = null;
    let marker = null;
    let geocoder = null;
    let placeSearch = null;
    let autocomplete = null;
    let selectedLocation = null;
    
    // 初始化地址输入框的值
    function initializeAddressInput() {
        const address = $('#hidden-address').val();
        if (address) {
            $('#address-input').val(address);
        }
    }
    
    // 页面加载时初始化
    initializeAddressInput();
    
    // 地址输入框搜索功能
    let searchTimeout;
    $('#address-input').on('input', function() {
        const keyword = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (keyword.length < 2) {
            $('#address-suggestions').hide();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            searchAddress(keyword);
        }, 300);
    });
    
    // 搜索地址
    function searchAddress(keyword) {
        if (!placeSearch) {
            placeSearch = new AMap.PlaceSearch({
                pageSize: 5,
                pageIndex: 1,
                city: '全国'
            });
        }
        
        placeSearch.search(keyword, function(status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                showAddressSuggestions(result.poiList.pois);
            } else {
                $('#address-suggestions').hide();
            }
        });
    }
    
    // 显示地址建议
    function showAddressSuggestions(pois) {
        const suggestions = $('#address-suggestions');
        suggestions.empty();
        
        pois.forEach(function(poi) {
            const item = $(`
                <a href="#" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${poi.name}</h6>
                        <small class="text-muted">${poi.type}</small>
                    </div>
                    <p class="mb-1">${poi.address}</p>
                    <small class="text-muted">${poi.cityname} ${poi.adname}</small>
                </a>
            `);
            
            item.on('click', function(e) {
                e.preventDefault();
                selectAddressFromSuggestion(poi);
            });
            
            suggestions.append(item);
        });
        
        suggestions.show();
    }
    
    // 从建议中选择地址
    function selectAddressFromSuggestion(poi) {
        const fullAddress = poi.address + poi.name;
        $('#address-input').val(fullAddress);
        $('#address-suggestions').hide();
        
        // 更新隐藏字段
        updateHiddenFields({
            address: fullAddress,
            province: poi.pname,
            city: poi.cityname,
            district: poi.adname,
            longitude: poi.location.lng,
            latitude: poi.location.lat
        });
    }
    
    // 点击其他地方隐藏建议
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#address-input, #address-suggestions').length) {
            $('#address-suggestions').hide();
        }
    });
    
    // 地图选择按钮
    $('#map-select-btn').on('click', function() {
        $('#mapSelectModal').modal('show');
        setTimeout(initMap, 500); // 延迟初始化地图
    });
    
    // 初始化地图
    function initMap() {
        if (map) return;
        
        map = new AMap.Map('map-container', {
            zoom: 10,
            center: [116.397428, 39.90923] // 默认北京
        });
        
        geocoder = new AMap.Geocoder();
        
        // 地图点击事件
        map.on('click', function(e) {
            const lnglat = e.lnglat;
            selectLocationOnMap(lnglat.lng, lnglat.lat);
        });
        
        // 如果已有坐标，显示在地图上
        const lng = $('#hidden-longitude').val();
        const lat = $('#hidden-latitude').val();
        if (lng && lat) {
            selectLocationOnMap(parseFloat(lng), parseFloat(lat));
            map.setCenter([lng, lat]);
        }
    }
    
    // 在地图上选择位置
    function selectLocationOnMap(lng, lat) {
        // 移除旧标记
        if (marker) {
            map.remove(marker);
        }
        
        // 添加新标记
        marker = new AMap.Marker({
            position: [lng, lat],
            map: map
        });
        
        selectedLocation = { lng: lng, lat: lat };
        $('#selected-coordinates').text(`${lng.toFixed(6)}, ${lat.toFixed(6)}`);
        $('#confirm-location-btn').prop('disabled', false);
        
        // 反向地理编码
        geocoder.getAddress([lng, lat], function(status, result) {
            if (status === 'complete' && result.regeocode) {
                const address = result.regeocode.formattedAddress;
                $('#selected-address').text(address);
                
                selectedLocation.address = address;
                selectedLocation.province = result.regeocode.addressComponent.province;
                selectedLocation.city = result.regeocode.addressComponent.city;
                selectedLocation.district = result.regeocode.addressComponent.district;
            }
        });
    }
    
    // 地图搜索
    $('#map-search-input').on('keypress', function(e) {
        if (e.which === 13) {
            searchOnMap($(this).val());
        }
    });
    
    // 在地图上搜索
    function searchOnMap(keyword) {
        if (!placeSearch) {
            placeSearch = new AMap.PlaceSearch({
                map: map,
                pageSize: 1
            });
        }
        
        placeSearch.search(keyword, function(status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                const poi = result.poiList.pois[0];
                selectLocationOnMap(poi.location.lng, poi.location.lat);
                map.setCenter([poi.location.lng, poi.location.lat]);
            }
        });
    }
    
    // 获取当前位置
    $('#get-location-btn').on('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lng = position.coords.longitude;
                const lat = position.coords.latitude;
                selectLocationOnMap(lng, lat);
                map.setCenter([lng, lat]);
            }, function(error) {
                alert('无法获取当前位置：' + error.message);
            });
        } else {
            alert('您的浏览器不支持地理定位功能');
        }
    });
    
    // 确认选择位置
    $('#confirm-location-btn').on('click', function() {
        if (selectedLocation) {
            $('#address-input').val(selectedLocation.address || '');
            updateHiddenFields(selectedLocation);
            $('#mapSelectModal').modal('hide');
        }
    });
    
    // 更新隐藏字段
    function updateHiddenFields(data) {
        if (data.address) $('#hidden-address').val(data.address);
        if (data.province) $('#hidden-province').val(data.province);
        if (data.city) $('#hidden-city').val(data.city);
        if (data.district) $('#hidden-district').val(data.district);
        if (data.longitude) $('#hidden-longitude').val(data.longitude);
        if (data.latitude) $('#hidden-latitude').val(data.latitude);
    }
    
    // 模态框关闭时重置
    $('#mapSelectModal').on('hidden.bs.modal', function() {
        $('#map-search-input').val('');
        $('#selected-address').text('请在地图上点击选择位置');
        $('#selected-coordinates').text('-');
        $('#confirm-location-btn').prop('disabled', true);
        selectedLocation = null;
    });
});
</script>

{% endblock %}